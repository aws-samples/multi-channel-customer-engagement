AWSTemplateFormatVersion: "2010-09-09"
Parameters:
  ChatContactFlowId :
    Type: String
    Default: 81c1b782-1556-4065-a93a-e1612ae28cd3
  DestinationPhoneNumber:
    Type: String
    Default: "+573108741528"
  InstanceId:
    Type: String
    Default: 4ce3c38f-281e-4e25-90a6-77c93a5778e2
  QueueId:
    Type: String
    Default: 0924cc42-78ed-4c3e-b334-a3256261027f
  Currency:
    Type: String
    Default: USD
  Language:
    Type: String
    Default: en
    AllowedValues: 
        - en
        - es
  S3BucketAssetsMain:
    Type: String
    Default: "omnichannel-assets-us-east-1"
    AllowedValues: 
        - omnichannel-assets-us-east-1
        - omnichannel-assets-us-west-2

Resources:
  stackAlexaLexBackend:
    DependsOn:
      - stackAgentPortalFrontEnd
      - stackCustomerPortalFrontEnd
    Type: AWS::CloudFormation::Stack
    Properties:
        TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/alexaLexDynamo-backend.yaml"
        Parameters: 
          ContactFlowId: !Ref ChatContactFlowId 
          DestinationPhoneNumber: !Ref DestinationPhoneNumber
          InstanceId: !Ref InstanceId
          QueueId: !Ref QueueId
          Currency: !Ref Currency
          Language: !Ref Language
          S3BucketAssets: !Ref S3BucketAssetsMain

  stackVoiceAnalytics:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/voiceAnalytics.yaml"
      Parameters: 
        TableInteractionsVoice: !GetAtt stackAlexaLexBackend.Outputs.DynamoDBTableCustomerInteractionsVoice
        Language: !Ref Language
        S3BucketAssets: !Ref S3BucketAssetsMain

  stackCustomerPortalFrontEnd: 
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/customer-portal-front-end.yaml"
      Parameters: 
        S3BucketAssets: !Ref S3BucketAssetsMain

  stackAgentPortalFrontEnd:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/agent-portal-front-end.yaml"
      Parameters: 
        S3BucketAssets: !Ref S3BucketAssetsMain


  stackConnectChatBackend:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/connect-chat-backend.yaml"
      Parameters: 
        comprehendTranscriptLambdaArn: !GetAtt stackVoiceAnalytics.Outputs.comprehendTranscriptLambdaArn
        executeTranscriptionStateMachineArn: !GetAtt stackVoiceAnalytics.Outputs.executeTranscriptionStateMachineArn
        customerPortalUrl: !GetAtt stackCustomerPortalFrontEnd.Outputs.DomainName
        connectContactFlowId: !Ref ChatContactFlowId 
        connectInstanceId: !Ref InstanceId
        connectS3BucketName: !GetAtt stackVoiceAnalytics.Outputs.S3Bucket
        transcriptPath : "/ChatTranscripts"
        S3BucketAssets: !Ref S3BucketAssetsMain

  stackAPIGatewayBackend:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/apiGateway-backend.yaml"
      Parameters:
        TableCustomerInfo: !GetAtt stackAlexaLexBackend.Outputs.DynamoDBTableCustomerInfo
        TableAppInteractions: !GetAtt stackAlexaLexBackend.Outputs.DynamoDBTableCustomerInteractionsApp
        TableVoiceInteraction: !GetAtt stackAlexaLexBackend.Outputs.DynamoDBTableCustomerInteractionsVoice
        TableChatInteraction: !GetAtt stackAlexaLexBackend.Outputs.DynamoDBTableCustomerInteractionsChat
        LambdaConnectChatARN: !GetAtt stackConnectChatBackend.Outputs.initiateChatLambda
        S3BucketAssets: !Ref S3BucketAssetsMain

  stackCognitoAppClientSettings:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/cognito-appClientSettings.yaml"
      Parameters:
        cognitoUserPoolId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoUserPool
        cognitoCustomerPortalClientId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoAppClientCustomer
        callbackLogOutCustomerURL: !GetAtt stackCustomerPortalFrontEnd.Outputs.DomainName
        cognitoAgentPortalClientId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoAppClientAgent
        callbackLogOutAgentURL: !GetAtt  stackAgentPortalFrontEnd.Outputs.DomainName
        S3BucketAssets: !Ref S3BucketAssetsMain

  stackCustomerPortalFrontEndSettings:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub "https://${S3BucketAssetsMain}.s3.amazonaws.com/cloudformation/customer-portal-config.yaml"
      Parameters:
          S3BucketAssets: !Ref S3BucketAssetsMain
          CustomerPortalS3Bucket: !GetAtt stackCustomerPortalFrontEnd.Outputs.BucketName
          AgentPortalS3Bucket: !GetAtt stackAgentPortalFrontEnd.Outputs.BucketName
          CustomerPortalUrl: !GetAtt stackCustomerPortalFrontEnd.Outputs.DomainName
          AgentPortalUrl: !GetAtt stackAgentPortalFrontEnd.Outputs.DomainName
          cognitoIdentityPoolId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoIdP
          cognitoCustomerPortalClientId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoAppClientCustomer
          cognitoAgentPortalClientId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoAppClientAgent
          cognitoDomain: !GetAtt stackAPIGatewayBackend.Outputs.UrlCustomDomainCognito
          connectInstanceId: !Ref InstanceId
          connectContactFlowId: !Ref ChatContactFlowId
          apiGatewayEndpoint: !GetAtt stackAPIGatewayBackend.Outputs.URIApiGateway
          kinesisStreamName: !GetAtt stackAPIGatewayBackend.Outputs.KinesisClickStreamName
          pinPointAppId: !GetAtt stackAPIGatewayBackend.Outputs.pinpointAppId
          cognitoUserPoolId: !GetAtt stackAPIGatewayBackend.Outputs.CognitoUserPool

Outputs: 

  AgentDomainName:
    Value: !GetAtt stackAgentPortalFrontEnd.Outputs.DomainName
    Description: Web site endpoint for Agent Portal

  CustomerDomainName:
    Value: !GetAtt stackCustomerPortalFrontEnd.Outputs.DomainName
    Description: Web site endpoint for Customer Portal

  S3ConnectBucket:
    Value: !GetAtt stackVoiceAnalytics.Outputs.S3Bucket
    Description: S3 Bucket to store call recording/transcript/comprehend outputs
